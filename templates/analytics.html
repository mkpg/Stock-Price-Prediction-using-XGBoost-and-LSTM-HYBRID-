<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics — QuantumTrade Pro</title>
    <meta name="description" content="Deep analytics and model performance insights for AI stock predictions.">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <div class="bg-grid"></div>
    <div class="bg-glow"></div>

    <!-- Navigation -->
    <nav class="navbar-pro">
        <a href="/" class="logo">
            <div class="logo-icon">⚡</div>
            <span>QuantumTrade<span style="color: var(--accent-cyan); font-weight: 400;">PRO</span></span>
        </a>
        <ul class="nav-links">
            <li><a href="/">Predict</a></li>
            <li><a href="/analytics" class="active">Analytics</a></li>
            <li><a href="/portfolio">Portfolio</a></li>
            <li><a href="/history">History</a></li>
        </ul>
        <div class="nav-actions">
            {% if logged_in %}
            <a href="/profile" class="nav-user-btn" title="Profile">
                <i class="bi bi-person-circle"></i>
                <span class="nav-username">{{ current_user.first_name }}</span>
            </a>
            <a href="/logout" class="nav-logout-btn" title="Logout">
                <i class="bi bi-box-arrow-right"></i>
            </a>
            {% else %}
            <a href="/login" class="nav-login-btn">Sign In</a>
            {% endif %}
            <button class="theme-btn" id="themeToggle"><i class="bi bi-moon-stars-fill"></i></button>
            <button class="mobile-nav-btn" id="mobileNavBtn">
                <i class="bi bi-list"></i>
            </button>
        </div>
    </nav>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-messages container-pro">
        {% for category, message in messages %}
        <div class="flash-msg flash-{{ category }}">
            <span>{{ message }}</span>
            <button onclick="this.parentElement.remove()" class="flash-close">&times;</button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}


    <main class="main-wrapper">
        <div class="container-pro section-spacing">
            <!-- Header -->
            <div class="section-header">
                <h1><i class="bi bi-bar-chart-line" style="color: var(--accent-cyan);"></i> Analytics Dashboard</h1>
                <p>Deep dive into model performance, accuracy trends, and market insights</p>
            </div>
            <div class="section-divider"></div>

            {% if data.total_predictions == 0 %}
            <!-- Empty State -->
            <div class="predict-card" style="text-align: center; max-width: 600px; margin: 60px auto;">
                <i class="bi bi-bar-chart-line" style="font-size: 3rem; color: var(--accent-cyan); opacity: 0.5;"></i>
                <h2 style="margin-top: 16px; color: var(--text-primary);">No Analytics Data Yet</h2>
                <p style="color: var(--text-muted); margin-bottom: 24px;">
                    Run some predictions on the <a href="/" style="color: var(--accent-cyan);">Predict page</a> to start
                    building your analytics dashboard.
                    Every prediction you make will be tracked and analyzed here.
                </p>
                <a href="/" class="predict-btn" style="display: inline-flex; text-decoration: none;">
                    <i class="bi bi-play-circle-fill"></i> Make Your First Prediction
                </a>
            </div>
            {% else %}

            <!-- KPI Stats -->
            <div class="stat-grid">
                <div class="stat-card-pro animate-in animate-in-delay-1">
                    <div class="stat-value" style="color: var(--accent-cyan);">{{ "{:,}".format(data.total_predictions)
                        }}</div>
                    <div class="stat-label">Total Predictions</div>
                    <div class="stat-change {% if data.pred_change >= 0 %}positive{% else %}negative{% endif %}">
                        <i class="bi bi-arrow-{% if data.pred_change >= 0 %}up{% else %}down{% endif %}"></i>
                        {{ "%+d"|format(data.pred_change) }} this week
                    </div>
                </div>
                <div class="stat-card-pro animate-in animate-in-delay-2">
                    <div class="stat-value" style="color: var(--accent-green);">{{ data.avg_accuracy }}%</div>
                    <div class="stat-label">Avg Accuracy</div>
                    <div class="stat-change {% if data.accuracy_change >= 0 %}positive{% else %}negative{% endif %}">
                        <i class="bi bi-arrow-{% if data.accuracy_change >= 0 %}up{% else %}down{% endif %}"></i>
                        {{ "%+.1f"|format(data.accuracy_change) }}%
                    </div>
                </div>
                <div class="stat-card-pro animate-in animate-in-delay-3">
                    <div class="stat-value"
                        style="color: {% if data.total_pnl >= 0 %}var(--accent-gold){% else %}var(--accent-red){% endif %};">
                        ${{ "{:,.0f}".format(data.total_pnl|abs) }}{% if data.total_pnl < 0 %} loss{% endif %} </div>
                            <div class="stat-label">Total P&L (Simulated)</div>
                            <div class="stat-change {% if data.total_pnl >= 0 %}positive{% else %}negative{% endif %}">
                                <i
                                    class="bi bi-{% if data.total_pnl >= 0 %}graph-up-arrow{% else %}graph-down-arrow{% endif %}"></i>
                                $10K position size
                            </div>
                    </div>
                    <div class="stat-card-pro animate-in animate-in-delay-4">
                        <div class="stat-value" style="color: var(--accent-purple);">{{ data.watchlist_count }}</div>
                        <div class="stat-label">Active Watchlist</div>
                        <div class="stat-change">
                            <i class="bi bi-star"></i>
                            {{ data.correct_count }} correct / {{ data.incorrect_count }} incorrect
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px;">
                    <!-- Accuracy Trend Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="bi bi-graph-up" style="color: var(--accent-green);"></i> Accuracy Trend (30
                                Days)
                            </h3>
                        </div>
                        <div class="chart-body" style="height: 280px;">
                            {% if data.accuracy_trend|length > 0 %}
                            <canvas id="accuracyChart"></canvas>
                            {% else %}
                            <div
                                style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
                                <p>Need more daily predictions to show trend</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Signal Distribution -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="bi bi-pie-chart" style="color: var(--accent-purple);"></i> Signal Distribution
                            </h3>
                        </div>
                        <div class="chart-body" style="height: 280px;">
                            <canvas id="signalChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Performance by Sector & Model -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px;">
                    <!-- Sector Performance -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="bi bi-diagram-3" style="color: var(--accent-cyan);"></i> Win Rate by Sector
                            </h3>
                        </div>
                        <div class="chart-body" style="padding: 24px 28px;">
                            {% if data.sector_performance %}
                            {% for sector, stats in data.sector_performance.items() %}
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 0.85rem; font-weight: 600;">{{ sector }}</span>
                                    <span
                                        style="font-family: var(--font-mono); font-weight: 700; color: {% if stats.win_rate >= 70 %}var(--accent-green){% elif stats.win_rate >= 50 %}var(--accent-cyan){% else %}var(--accent-red){% endif %};">
                                        {{ stats.win_rate }}%
                                        <span style="font-size: 0.7rem; color: var(--text-muted); font-weight: 400;">({{
                                            stats.total }} trades)</span>
                                    </span>
                                </div>
                                <div class="progress-pro">
                                    <div class="bar {% if stats.win_rate >= 70 %}green{% elif stats.win_rate >= 50 %}blue{% else %}red{% endif %}"
                                        style="width: {{ stats.win_rate }}%;"></div>
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <div
                                style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); padding: 40px 0;">
                                <p>Sector data will appear after outcomes are verified</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Model Performance -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="bi bi-cpu" style="color: var(--accent-gold);"></i> Model Performance</h3>
                        </div>
                        <div class="chart-body" style="padding: 24px 28px;">
                            <div style="margin-bottom: 28px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 0.9rem; font-weight: 700;">LSTM Neural Network</span>
                                    <span
                                        style="font-family: var(--font-mono); font-weight: 700; color: var(--accent-cyan);">{{
                                        data.model_performance.lstm_avg }}%</span>
                                </div>
                                <div class="progress-pro">
                                    <div class="bar blue" style="width: {{ data.model_performance.lstm_avg }}%;"></div>
                                </div>
                                <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 6px;">Bidirectional
                                    128→64→32 • Huber Loss</p>
                            </div>
                            <div style="margin-bottom: 28px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 0.9rem; font-weight: 700;">XGBoost Ensemble</span>
                                    <span
                                        style="font-family: var(--font-mono); font-weight: 700; color: var(--accent-green);">{{
                                        data.model_performance.xgb_avg }}%</span>
                                </div>
                                <div class="progress-pro">
                                    <div class="bar green" style="width: {{ data.model_performance.xgb_avg }}%;"></div>
                                </div>
                                <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 6px;">1000 Trees •
                                    Depth
                                    6 • L1/L2 Regularized</p>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 0.9rem; font-weight: 700;">Hybrid Ensemble</span>
                                    <span
                                        style="font-family: var(--font-mono); font-weight: 700; color: var(--accent-gold);">{{
                                        data.model_performance.ensemble_avg }}%</span>
                                </div>
                                <div class="progress-pro">
                                    <div class="bar"
                                        style="width: {{ data.model_performance.ensemble_avg }}%; background: linear-gradient(90deg, var(--accent-gold), var(--accent-orange));">
                                    </div>
                                </div>
                                <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 6px;">Dynamic
                                    Weighted •
                                    Walk-Forward Validated</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Predictions -->
                <div class="data-table-wrapper">
                    <div class="data-table-header">
                        <h3><i class="bi bi-clock-history" style="color: var(--accent-cyan);"></i> Recent Predictions
                        </h3>
                        <a href="/history" class="btn-outline"><i class="bi bi-arrow-right"></i> View All</a>
                    </div>
                    {% if data.recent_predictions|length > 0 %}
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Signal</th>
                                <th>Accuracy</th>
                                <th>MAPE</th>
                                <th>Date</th>
                                <th>Outcome</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pred in data.recent_predictions %}
                            <tr>
                                <td class="ticker-cell">{{ pred.ticker }}</td>
                                <td>
                                    <span class="badge-pro badge-{{ pred.signal_class }}">{{ pred.signal }}</span>
                                </td>
                                <td
                                    style="font-family: var(--font-mono); font-weight: 700; color: {% if pred.directional_accuracy >= 75 %}var(--accent-green){% elif pred.directional_accuracy >= 60 %}var(--accent-cyan){% else %}var(--accent-red){% endif %};">
                                    {{ pred.directional_accuracy }}%
                                </td>
                                <td style="font-family: var(--font-mono);">{{ pred.mape }}%</td>
                                <td style="color: var(--text-muted);">{{ pred.created_at }}</td>
                                <td>
                                    {% if pred.outcome == "correct" %}
                                    <span class="badge-pro badge-correct">✓ Correct</span>
                                    {% elif pred.outcome == "incorrect" %}
                                    <span class="badge-pro badge-incorrect">✗ Incorrect</span>
                                    {% else %}
                                    <span class="badge-pro"
                                        style="background: rgba(255,215,0,0.12); color: var(--accent-gold);">⏳
                                        Pending</span>
                                    {% endif %}
                                </td>
                                <td><a href="/" class="btn-outline"
                                        style="padding: 4px 12px; font-size: 0.7rem;">Predict</a></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        No predictions yet. <a href="/" style="color: var(--accent-cyan);">Make one now!</a>
                    </div>
                    {% endif %}
                </div>

                {% endif %}
            </div>
    </main>

    <footer class="footer-pro">
        <div class="container-pro footer-content">
            <div class="footer-brand">⚡ <span>QuantumTrade PRO</span></div>
            <div class="footer-text">Industrial-grade AI Stock Prediction • © 2026</div>
        </div>
    </footer>

    {% if data.total_predictions > 0 %}
    <script>
        // ===== Accuracy Trend Chart (from REAL MongoDB data) =====
        {% if data.accuracy_trend | length > 0 %}
        const ctx1 = document.getElementById('accuracyChart').getContext('2d');
        const trendLabels = {{ data.accuracy_trend| map(attribute = '_id') | list | tojson }};
        const trendValues = {{ data.accuracy_trend| map(attribute = 'avg_acc') | list | tojson }};

        // Format labels to shorter format
        const formattedLabels = trendLabels.map(d => {
            const parts = d.split('-');
            return `${parseInt(parts[1])}/${parseInt(parts[2])}`;
        });

        new Chart(ctx1, {
            type: 'line',
            data: {
                labels: formattedLabels,
                datasets: [{
                    label: 'Accuracy %',
                    data: trendValues.map(v => Math.round(v * 10) / 10),
                    borderColor: '#00ff88',
                    backgroundColor: 'rgba(0, 255, 136, 0.05)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointRadius: trendValues.length <= 15 ? 4 : 0,
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: '#00ff88',
                    pointBackgroundColor: '#00ff88',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255,255,255,0.03)' },
                        ticks: { color: '#5a5a78', font: { size: 10 }, maxTicksLimit: 8 }
                    },
                    y: {
                        min: Math.max(0, Math.min(...trendValues) - 10),
                        max: 100,
                        grid: { color: 'rgba(255,255,255,0.03)' },
                        ticks: { color: '#5a5a78', font: { size: 10 }, callback: v => v + '%' }
                    }
                }
            }
        });
        {% endif %}

        // ===== Signal Distribution (from REAL MongoDB data) =====
        const ctx2 = document.getElementById('signalChart').getContext('2d');
        const signalData = {{ data.signal_distribution| tojson }};

        new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: Object.keys(signalData),
                datasets: [{
                    data: Object.values(signalData),
                    backgroundColor: ['#00ff88', '#4f8cff', '#ffd700', '#ff6b35', '#ff4757'],
                    borderWidth: 0,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#8b8ba3',
                            font: { size: 11, weight: 600 },
                            padding: 16,
                            usePointStyle: true,
                            pointStyleWidth: 8
                        }
                    }
                }
            }
        });
    </script>
    {% endif %}
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>

</html>